datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  PACIENTE
  PROFISSIONAL
  ADMIN
}

enum ConsultaStatus {
  AGENDADA
  CONCLUIDA
  CANCELADA
  FALTA
}

enum Prioridade {
  P1
  P2
  P3
  P4
  P5
}

enum WhatsStatus {
  ATIVO
  INATIVO
  PENDENTE
}

model User {
  id            Int         @id @default(autoincrement())
  nome          String
  cpf           String       @unique
  email         String?      @unique
  senhaHash     String
  telefone      String?
  role          UserRole     @default(PACIENTE)
  whatsStatus   WhatsStatus  @default(PENDENTE)

  paciente      Paciente?
  profissional  Profissional?

  criadoEm      DateTime     @default(now())
  atualizadoEm  DateTime     @updatedAt

  logAdmins     LogAdmin[]

  @@map("users")
}

model Organizacao {
  id             Int              @id @default(autoincrement())
  nome           String
  tipo           String
  endereco       String?

  profissionais  Profissional[]
  consultas      Consulta[]

  @@map("organizacoes")
}

model Paciente {
  id             Int          @id @default(autoincrement())
  userId         Int          @unique
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  consultas      Consulta[]
  attendanceStats AttendanceStats[]

  @@map("pacientes")
}

model Profissional {
  id             Int              @id @default(autoincrement())
  userId         Int              @unique
  organizacaoId  Int

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizacao    Organizacao      @relation(fields: [organizacaoId], references: [id], onDelete: Cascade)

  especialidade  String
  registro       String?

  consultas      Consulta[]
  agenda         AgendaProfissional[]

  @@map("profissionais")
}

model Consulta {
  id              Int              @id @default(autoincrement())
  pacienteId      Int
  profissionalId  Int
  organizacaoId   Int

  dataHora        DateTime
  prioridade      Prioridade
  status          ConsultaStatus   @default(AGENDADA)
  compareceu      Boolean?

  paciente        Paciente         @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  profissional    Profissional     @relation(fields: [profissionalId], references: [id], onDelete: Cascade)
  organizacao     Organizacao      @relation(fields: [organizacaoId], references: [id], onDelete: Cascade)

  criadoEm        DateTime         @default(now())

  @@map("consultas")
}

model AgendaProfissional {
  id              Int          @id @default(autoincrement())
  profissionalId  Int
  inicio          DateTime
  fim             DateTime
  disponivel      Boolean      @default(true)

  profissional    Profissional @relation(fields: [profissionalId], references: [id], onDelete: Cascade)

  @@map("agenda_profissional")
}

model AttendanceStats {
  id            Int       @id @default(autoincrement())
  pacienteId    Int       @unique
  total         Int       @default(0)
  presencas     Int       @default(0)

  paciente      Paciente  @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  @@map("attendance_stats")
}

model LogAdmin {
  id          Int       @id @default(autoincrement())
  adminId     Int
  acao        String
  detalhes    String?
  criadoEm    DateTime   @default(now())

  admin       User       @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("log_admins")
}
